<!doctype html>
<html lang="en" style="height:100%">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microphone Volume Detector</title>
    <style>
        #message {
            display: none;
            font-size: 24px;
            color: green;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>

<body>
    <div id="message">OK</div>

    <script>
        async function sendDataToJsonBlob() {
            const data = {
                "currentStatus": true
            };

            try {
                const response = await fetch("https://jsonblob.com/api/jsonBlob", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Accept": "application/json",
                        "apiKey": "1303933584375930880"
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const location = response.headers.get("Location");
                    console.log("Data successfully posted to JSONBlob. Blob URL:", location);
                } else {
                    sendDataToJsonBlob();
                    console.error("Failed to post data:", response.statusText);
                }
            } catch (error) {
                sendDataToJsonBlob();
                console.error("Error posting data to JSONBlob:", error);
            }
        }

        async function getMicrophone() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                console.log("Microphone access granted.");

                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                source.connect(analyser);

                function checkVolume() {
                    analyser.getByteFrequencyData(dataArray);

                    // Calculate the average volume level
                    let sum = 0;
                    for (let i = 0; i < dataArray.length; i++) {
                        sum += dataArray[i];
                    }
                    const averageVolume = sum / dataArray.length;

                    // Show message if loud sound is detected
                    if (averageVolume > 25) {
                        showOkMessage();
                        sendDataToJsonBlob();
                    }

                    requestAnimationFrame(checkVolume);
                }

                function showOkMessage() {
                    const message = document.getElementById("message");
                    message.style.display = "block";

                    // Hide the message after 2 seconds
                    setTimeout(() => {
                        message.style.display = "none";
                    }, 2000);
                }

                checkVolume();
            } catch (error) {
                console.error("Microphone access denied or error occurred:", error);
            }
        }

        getMicrophone();
    </script>
</body>

</html>